<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0d0d1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="V√©ra ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞, –±–∏–æ—Ä–∏—Ç–º–æ–≤ –∏ —Ç–∞—Ä–æ">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVsOpcmEiLCJzaG9ydF9uYW1lIjoiVsOpcmEiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBkMGQxYSIsInRoZW1lX2NvbG9yIjoiIzBkMGQxYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBIQStQZz09Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
<title>V√©ra</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0d0d1a;
  --deep: #111128;
  --mid: #1a1a35;
  --lift: #232342;
  --veil: #2e2e50;
  --gold: #c9a84c;
  --gold2: #e8c96a;
  --rose: #d4788a;
  --moon: #e8e0d0;
  --mist: #a09880;
  --fog:  #5a5470;
  --teal: #4ecdc4;
  --soft: rgba(255,255,255,.055);
  --softer: rgba(255,255,255,.03);
  --border: rgba(201,168,76,.12);
  --border2: rgba(201,168,76,.25);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{height:100%; touch-action:manipulation}
body {
  background: var(--ink);
  color: var(--moon);
  font-family: 'Jost', sans-serif;
  font-weight: 300;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  -webkit-tap-highlight-color: transparent;
}

/* ‚îÄ‚îÄ Atmospheric BG ‚îÄ‚îÄ */
body::before {
  content:'';
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse 80% 60% at 50% -10%, rgba(100,80,180,.18) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 10% 80%, rgba(201,168,76,.06) 0%, transparent 50%),
    radial-gradient(ellipse 40% 50% at 90% 30%, rgba(212,120,138,.07) 0%, transparent 50%);
}
body::after {
  content:'';
  position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  background-size: 200px;
}

/* ‚îÄ‚îÄ Install Prompt ‚îÄ‚îÄ */
#installPrompt {
  display:none; position:fixed; bottom:80px; left:50%;
  transform:translateX(-50%);
  background:var(--lift); border:1px solid var(--border2);
  border-radius:16px; padding:16px 20px; z-index:300;
  box-shadow:0 10px 40px rgba(0,0,0,.5);
  max-width:320px; width:90%;
}
#installPrompt.show { display:block; animation:rise .3s ease }
.install-title { font-family:'Cormorant Garamond',serif; font-size:18px; color:var(--gold2); margin-bottom:8px }
.install-text { font-size:13px; color:var(--mist); margin-bottom:12px }
.install-btns { display:flex; gap:8px }
.install-btn { flex:1; padding:10px; border-radius:10px; border:none; font-family:'Jost',sans-serif; font-size:13px; cursor:pointer }
.install-btn.primary { background:var(--gold); color:#1a1400 }
.install-btn.secondary { background:var(--soft); color:var(--moon); border:1px solid var(--border2) }

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
.nav {
  position: sticky; top:0; z-index:50;
  background: rgba(13,13,26,.88);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  height: 56px; padding: 0 16px; gap:0;
}
.brand {
  font-family: 'Cormorant Garamond', serif;
  font-size: 22px; font-weight: 500; font-style: italic;
  color: var(--gold2); letter-spacing:.05em;
  margin-right: 18px; flex-shrink:0;
}
.brand sup { font-size:10px; vertical-align:super; margin-left:1px }
.tabs { display:flex; gap:2px; flex:1; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch }
.tabs::-webkit-scrollbar { display:none }
.tab {
  padding: 7px 13px; border-radius: 8px;
  font-family:'Jost',sans-serif; font-size:12px; font-weight:400; letter-spacing:.03em;
  color: var(--fog); cursor:pointer; white-space:nowrap;
  border:none; background:none; touch-action:manipulation;
  transition: all .2s;
}
.tab:hover, .tab:active { color: var(--mist) }
.tab.on { color: var(--moon); background: var(--soft) }
.moon-live { font-size:18px; margin-left:auto; flex-shrink:0 }

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
.page { display:none; position:relative; z-index:1; min-height:calc(100vh - 56px) }
.page.on { display:block; animation: rise .4s ease both }
.wrap { max-width:860px; margin:0 auto; padding:28px 16px 80px }

/* ‚îÄ‚îÄ Typography ‚îÄ‚îÄ */
.display {
  font-family:'Cormorant Garamond',serif;
  font-size: clamp(28px,6vw,44px);
  font-weight:400; font-style:italic; line-height:1.1;
  letter-spacing:-.01em;
}
.title {
  font-family:'Cormorant Garamond',serif;
  font-size: clamp(20px,4vw,28px);
  font-weight:400; line-height:1.2;
}
.label { font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:var(--fog); font-weight:500 }
.muted { color:var(--mist); font-size:13px; line-height:1.65 }
.gold { color:var(--gold2) }
.rose { color:var(--rose) }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background: var(--softer);
  border: 1px solid var(--border);
  border-radius: 20px; padding:22px;
  backdrop-filter: blur(8px);
}
.card + .card { margin-top:10px }
.card-sm { padding: 16px }
.card-gold {
  background: linear-gradient(135deg, rgba(201,168,76,.06), rgba(232,201,106,.03));
  border-color: var(--border2);
}

/* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
.g2 { display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
.g3 { display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
@media(max-width:520px){ .g3 { grid-template-columns:repeat(2,1fr) } }
@media(max-width:380px){ .g2 { grid-template-columns:1fr } }

/* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
.sep {
  height:1px; margin:18px 0;
  background: linear-gradient(90deg, transparent, var(--border2), transparent);
}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  padding: 10px 20px; border-radius:10px;
  font-family:'Jost',sans-serif; font-size:13px; font-weight:400; letter-spacing:.04em;
  cursor:pointer; border:none; touch-action:manipulation;
  transition: all .2s;
}
.btn:hover, .btn:active { filter:brightness(1.1); transform:translateY(-1px) }
.btn:active { transform:translateY(0) }
.btn-gold { background: linear-gradient(135deg,#b8913a,#d4aa50); color:#1a1400 }
.btn-ghost { background:var(--soft); color:var(--moon); border:1px solid var(--border2) }
.btn-rose { background: linear-gradient(135deg,#b05060,#c96878); color:#fff }
.btn-ai { background: linear-gradient(135deg,#2d5a5a,#3d7a70); color:var(--teal) }
.btn-sm { padding:7px 14px; font-size:11px }
.btn-w { width:100% }

/* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
.field { display:flex; flex-direction:column; gap:6px }
.field label { font-size:10px; letter-spacing:.1em; text-transform:uppercase; color:var(--fog) }
.field input, .field select, .field textarea {
  background: var(--mid);
  border: 1px solid var(--border2);
  border-radius: 10px; padding:10px 14px;
  color: var(--moon); font-family:'Jost',sans-serif; font-size:14px; font-weight:300;
  outline:none; transition:border-color .2s;
  -webkit-appearance:none; appearance:none;
}
.field input:focus, .field select:focus, .field textarea:focus { border-color: var(--gold) }
.field textarea { min-height:80px; resize:vertical; line-height:1.6 }
.field select option { background: var(--mid) }
.fgrid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin:14px 0 }
@media(max-width:480px){ .fgrid { grid-template-columns:1fr } }

/* ‚îÄ‚îÄ Tags ‚îÄ‚îÄ */
.tag {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:20px; font-size:11px; letter-spacing:.04em;
}
.tag-gold { background:rgba(201,168,76,.1); border:1px solid rgba(201,168,76,.25); color:var(--gold2) }
.tag-rose { background:rgba(212,120,138,.1); border:1px solid rgba(212,120,138,.25); color:var(--rose) }
.tag-teal { background:rgba(78,205,196,.08); border:1px solid rgba(78,205,196,.2); color:var(--teal) }
.tag-mist { background:rgba(160,152,128,.08); border:1px solid rgba(160,152,128,.2); color:var(--mist) }

/* ‚îÄ‚îÄ Moon phases ‚îÄ‚îÄ */
.moon-phase { font-size:42px; line-height:1 }
.moon-strip {
  display:flex; gap:4px; justify-content:space-between;
  margin:14px 0; overflow-x:auto; padding:4px 0;
  -webkit-overflow-scrolling:touch; scrollbar-width:none;
}
.moon-strip::-webkit-scrollbar { display:none }
.moon-day {
  display:flex; flex-direction:column; align-items:center; gap:4px;
  min-width:32px; padding:8px 4px; border-radius:10px;
  font-size:10px; color:var(--fog);
  transition:background .2s;
}
.moon-day.today { background:var(--soft); color:var(--gold2) }
.moon-day.today .mico { filter:drop-shadow(0 0 6px rgba(201,168,76,.5)) }
.mico { font-size:20px }

/* ‚îÄ‚îÄ Cycle Calendar ‚îÄ‚îÄ */
.cal-hdr { display:grid; grid-template-columns:repeat(7,1fr); gap:3px; margin-bottom:5px }
.cal-hdr span { text-align:center; font-size:10px; color:var(--fog); letter-spacing:.06em }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:3px }
.cday {
  aspect-ratio:1; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:400; cursor:pointer;
  background: var(--softer); color:var(--fog);
  border:1px solid transparent;
  transition:all .18s; position:relative;
  touch-action:manipulation;
}
.cday:hover, .cday:active { border-color:var(--border2); color:var(--mist) }
.cday.today { border-color:var(--gold); color:var(--gold2) }
.cday.period { background:rgba(212,120,138,.15); border-color:rgba(212,120,138,.3); color:var(--rose) }
.cday.fertile { background:rgba(78,205,196,.08); border-color:rgba(78,205,196,.2); color:var(--teal) }
.cday.ovulation { background:rgba(201,168,76,.15); border-color:var(--border2); color:var(--gold2) }
.cday.has-note::after {
  content:''; position:absolute; bottom:3px; left:50%; transform:translateX(-50%);
  width:3px; height:3px; border-radius:50%; background:var(--gold);
}
.cal-legend { display:flex; gap:14px; flex-wrap:wrap; font-size:11px; color:var(--mist); margin-top:10px }
.ldot { width:8px; height:8px; border-radius:2px; display:inline-block; margin-right:4px; vertical-align:middle }

/* ‚îÄ‚îÄ Symptom pills ‚îÄ‚îÄ */
.symp-row { display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 }
.spill {
  padding:7px 14px; border-radius:20px; font-size:12px; font-weight:400;
  background:var(--mid); border:1px solid var(--border);
  color:var(--mist); cursor:pointer; touch-action:manipulation;
  transition:all .2s;
}
.spill:hover, .spill:active { border-color:var(--border2) }
.spill.on { background:rgba(201,168,76,.1); border-color:rgba(201,168,76,.35); color:var(--gold2) }

/* ‚îÄ‚îÄ Energy slider ‚îÄ‚îÄ */
.energy-track {
  height:8px; background:var(--mid); border-radius:4px;
  border:1px solid var(--border); overflow:visible; position:relative; margin:10px 0;
}
input[type=range] {
  width:100%; accent-color:var(--gold);
  margin:0; padding:0; height:20px;
  -webkit-appearance:none; appearance:none;
  background:transparent;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none; appearance:none;
  width:20px; height:20px; border-radius:50%;
  background:var(--gold); cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}
input[type=range]::-webkit-slider-runnable-track {
  height:8px; background:var(--mid); border-radius:4px;
}
.energy-labels { display:flex; justify-content:space-between; font-size:10px; color:var(--fog) }

/* ‚îÄ‚îÄ Biorhythm bars ‚îÄ‚îÄ */
.bio-row { display:flex; align-items:center; gap:12px; margin-bottom:12px }
.bio-label { font-size:12px; min-width:82px; color:var(--mist) }
.bio-track {
  flex:1; height:8px; background:var(--mid); border-radius:4px;
  border:1px solid var(--border); position:relative; overflow:hidden;
}
.bio-zero { position:absolute; left:50%; top:0; width:1px; height:100%; background:var(--border2) }
.bio-fill { height:100%; border-radius:4px; position:absolute; transition:width .9s cubic-bezier(.4,0,.2,1) }
.bio-val { font-size:12px; min-width:44px; text-align:right }
.bio-week { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-top:12px }
.bw-day {
  text-align:center; background:var(--mid); border-radius:8px; padding:8px 3px;
  border:1px solid var(--border);
}
.bw-day.today { border-color:var(--border2) }
.bw-lbl { font-size:9px; color:var(--fog); margin-bottom:4px }
.bw-val { font-family:'Cormorant Garamond',serif; font-size:15px; font-weight:500 }

/* ‚îÄ‚îÄ Tarot ‚îÄ‚îÄ */
.tarot-card-display {
  background: linear-gradient(160deg, var(--lift), var(--mid));
  border: 1px solid var(--border2);
  border-radius: 16px; padding:24px;
  text-align:center; position:relative; overflow:hidden;
}
.tarot-card-display::before {
  content:''; position:absolute; inset:0;
  background: radial-gradient(ellipse at 50% 0%, rgba(201,168,76,.08), transparent 60%);
}
.tarot-name-big {
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(22px,5vw,34px); font-weight:400; font-style:italic;
  color:var(--gold2); margin:8px 0 4px;
}
.tarot-num { font-size:11px; letter-spacing:.12em; color:var(--fog) }
.tarot-symbol { font-size:52px; margin:12px 0 }

/* ‚îÄ‚îÄ Analysis block ‚îÄ‚îÄ */
.analysis-glow {
  background: linear-gradient(135deg, rgba(13,13,26,.9), rgba(26,26,53,.7));
  border: 1px solid var(--border2);
  border-radius:20px; padding:24px;
  position:relative; overflow:hidden;
}
.analysis-glow::before {
  content:''; position:absolute; inset:0; border-radius:20px; pointer-events:none;
  background: radial-gradient(ellipse 70% 50% at 50% -10%, rgba(201,168,76,.07), transparent);
}
.insight-text {
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(15px,3vw,18px); font-style:italic;
  line-height:1.8; color:var(--moon);
}

/* ‚îÄ‚îÄ Journal entries ‚îÄ‚îÄ */
.entry {
  background:var(--softer); border:1px solid var(--border);
  border-radius:14px; padding:16px; margin-bottom:8px;
  animation: rise .25s ease both;
}
.entry-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
.entry-pills { display:flex; gap:5px; flex-wrap:wrap; margin-top:9px }
.epill { font-size:10px; padding:2px 8px; border-radius:10px; background:var(--mid); color:var(--mist) }

/* ‚îÄ‚îÄ Chat ‚îÄ‚îÄ */
.chat-wrap {
  border: 1px solid var(--border); border-radius:16px; overflow:hidden;
}
.chat-messages {
  min-height:240px; max-height:380px; overflow-y:auto;
  padding:16px; display:flex; flex-direction:column; gap:10px;
  background: var(--softer);
  -webkit-overflow-scrolling:touch;
}
.chat-messages::-webkit-scrollbar { width:3px }
.chat-messages::-webkit-scrollbar-thumb { background:var(--veil); border-radius:2px }
.cmsg { display:flex; gap:8px; animation:rise .2s ease both }
.cmsg.user { flex-direction:row-reverse }
.cav {
  width:28px; height:28px; border-radius:8px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:14px;
  background:var(--mid); border:1px solid var(--border);
}
.cmsg.ai .cav { border-color:rgba(201,168,76,.25) }
.cbub {
  max-width:84%; padding:11px 15px; border-radius:12px;
  font-size:13px; line-height:1.7; font-weight:300;
}
.cmsg.ai .cbub { background:var(--mid); border:1px solid var(--border); border-bottom-left-radius:3px }
.cmsg.user .cbub { background:rgba(201,168,76,.1); border:1px solid rgba(201,168,76,.2); border-bottom-right-radius:3px }
.chat-input-row {
  display:flex; gap:8px; padding:12px;
  background:var(--mid); border-top:1px solid var(--border);
}
.chat-in {
  flex:1; background:var(--lift); border:1px solid var(--border);
  border-radius:8px; padding:9px 12px;
  color:var(--moon); font-family:'Jost',sans-serif; font-size:13px; font-weight:300; outline:none;
  transition:border-color .2s;
}
.chat-in:focus { border-color:var(--gold) }
.chat-in::placeholder { color:var(--fog) }
.dot-pulse { display:flex; gap:3px; padding:3px 0 }
.dot-pulse span { width:4px; height:4px; border-radius:50%; background:var(--gold); animation:dp 1.2s infinite }
.dot-pulse span:nth-child(2){ animation-delay:.2s }
.dot-pulse span:nth-child(3){ animation-delay:.4s }

/* ‚îÄ‚îÄ Patterns chart ‚îÄ‚îÄ */
.pattern-row {
  display:flex; align-items:center; gap:8px; margin-bottom:8px;
  font-size:12px;
}
.pattern-bar { flex:1; height:6px; background:var(--mid); border-radius:3px; overflow:hidden }
.pattern-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--rose),var(--gold2)) }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast {
  position:fixed; bottom:24px; left:50%;
  transform:translateX(-50%) translateY(60px);
  background:var(--lift); border:1px solid var(--border2);
  border-radius:12px; padding:10px 22px;
  font-size:13px; color:var(--moon); z-index:200;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap; pointer-events:none;
}
#toast.on { transform:translateX(-50%) translateY(0) }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal-bg {
  display:none; position:fixed; inset:0; z-index:100;
  background:rgba(0,0,0,.65); backdrop-filter:blur(6px);
  align-items:center; justify-content:center; padding:16px;
}
.modal-bg.on { display:flex }
.modal {
  background:var(--deep); border:1px solid var(--border2);
  border-radius:22px; padding:26px; max-width:400px; width:100%;
  animation:rise .3s ease both; max-height:85vh; overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.modal::-webkit-scrollbar { width:3px }
.modal::-webkit-scrollbar-thumb { background:var(--veil) }

/* ‚îÄ‚îÄ API key banner ‚îÄ‚îÄ */
.api-banner {
  background:linear-gradient(135deg,rgba(78,205,196,.05),rgba(201,168,76,.04));
  border:1px solid rgba(78,205,196,.18); border-radius:14px; padding:14px;
  margin-bottom:14px;
}

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes rise { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
@keyframes dp { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-4px);opacity:1} }
@keyframes spin { to{transform:rotate(360deg)} }

/* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
.center { text-align:center }
.mt8 { margin-top:8px }
.mt12 { margin-top:12px }
.mt16 { margin-top:16px }
.mt20 { margin-top:20px }
.flex { display:flex; align-items:center }
.gap8 { gap:8px }
.gap12 { gap:12px }
.spread { justify-content:space-between }
.wrap-flex { flex-wrap:wrap }
</style>
</head>
<body>

<!-- Install Prompt -->
<div id="installPrompt">
  <div class="install-title">‚ú¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å V√©ra</div>
  <div class="install-text">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ —Ä–∞–±–æ—Ç—ã –æ—Ñ–ª–∞–π–Ω</div>
  <div class="install-btns">
    <button class="install-btn secondary" onclick="dismissInstall()">–ü–æ–∑–∂–µ</button>
    <button class="install-btn primary" onclick="installPWA()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  </div>
</div>

<!-- NAV -->
<nav class="nav">
  <div class="brand">V√©ra<sup>‚ú¶</sup></div>
  <div class="tabs">
    <button class="tab on" data-p="today">‚ú¶ –°–µ–≥–æ–¥–Ω—è</button>
    <button class="tab" data-p="cycle">üå∏ –¶–∏–∫–ª</button>
    <button class="tab" data-p="bio">üåä –ë–∏–æ—Ä–∏—Ç–º—ã</button>
    <button class="tab" data-p="tarot">üÉè –¢–∞—Ä–æ</button>
    <button class="tab" data-p="journal">üìì –î–Ω–µ–≤–Ω–∏–∫</button>
    <button class="tab" data-p="analysis">üîÆ –ê–Ω–∞–ª–∏–∑</button>
    <button class="tab" data-p="settings">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>
  <div class="moon-live" id="navMoon" title="–§–∞–∑–∞ –ª—É–Ω—ã">üåô</div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TODAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page on" id="page-today">
<div class="wrap">

  <div style="margin-bottom:24px">
    <div class="label" id="todayDateLabel" style="margin-bottom:6px"></div>
    <div class="display" id="todayGreeting">–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä</div>
    <div class="muted" id="todayName" style="margin-top:4px"></div>
  </div>

  <!-- Moon + Cycle strip -->
  <div class="card card-gold" style="margin-bottom:10px">
    <div class="flex gap12 spread wrap-flex">
      <div>
        <div class="label" style="margin-bottom:8px">–õ—É–Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
        <div class="flex gap12">
          <div class="moon-phase" id="todayMoonEmoji">üåô</div>
          <div>
            <div class="title" id="todayMoonName" style="font-size:16px">‚Äî</div>
            <div class="muted" style="font-size:12px;margin-top:2px" id="todayMoonDay">–¥–µ–Ω—å –ª—É–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ ‚Äî</div>
          </div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="label" style="margin-bottom:6px">–î–µ–Ω—å —Ü–∏–∫–ª–∞</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:38px;font-weight:400;color:var(--rose);line-height:1" id="todayCycleDay">‚Äî</div>
        <div class="muted" style="font-size:11px" id="todayCyclePhase">‚Äî</div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- 7-day moon strip -->
    <div class="label" style="margin-bottom:10px">–õ—É–Ω–∞ ‚Äî 7 –¥–Ω–µ–π</div>
    <div class="moon-strip" id="moonStrip"></div>
  </div>

  <!-- Biorhythms today -->
  <div class="card" style="margin-bottom:10px; display:none" id="todayBioCard">
    <div class="label" style="margin-bottom:12px">–ë–∏–æ—Ä–∏—Ç–º—ã —Å–µ–≥–æ–¥–Ω—è</div>
    <div id="todayBioMini"></div>
    <div class="muted" style="font-size:11px;margin-top:8px" id="todayBioHint"></div>
  </div>

  <!-- Tarot today -->
  <div class="card card-gold" style="margin-bottom:10px" id="todayTarotCard">
    <div class="label" style="margin-bottom:10px">–ö–∞—Ä—Ç–∞ –¥–Ω—è</div>
    <div id="todayTarotContent">
      <div class="muted">–ö–∞—Ä—Ç–∞ –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è.<br>–ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É üÉè –¢–∞—Ä–æ</div>
    </div>
  </div>

  <!-- Quick log -->
  <div class="card" style="margin-bottom:10px">
    <div class="label" style="margin-bottom:10px">–ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?</div>
    <div class="symp-row" id="quickSymptoms"></div>
    <div style="margin-top:12px">
      <div class="label" style="margin-bottom:8px">–≠–Ω–µ—Ä–≥–∏—è</div>
      <input type="range" id="energySlider" min="1" max="10" value="5" oninput="updateEnergy()">
      <div class="energy-labels"><span>üò¥ –ò—Å—Ç–æ—â–µ–Ω–∞</span><span id="energyVal">5</span><span>‚ö° –ü–æ–ª–Ω–∞ —Å–∏–ª</span></div>
    </div>
    <div class="field" style="margin-top:12px">
      <label>–ó–∞–º–µ—Ç–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</label>
      <textarea id="quickNote" placeholder="–ß—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ –≤–∞–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å..."></textarea>
    </div>
    <button class="btn btn-gold btn-w mt12" onclick="saveToday()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
  </div>

  <!-- AI insight -->
  <div class="analysis-glow" id="todayInsightCard">
    <div class="label" style="margin-bottom:14px">‚ú¶ –°–≤–æ–¥–∫–∞ –¥–Ω—è –æ—Ç V√©ra</div>
    <div id="todayInsightContent">
      <div class="muted" style="font-style:italic">–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤–≤–µ–¥–∏ API –∫–ª—é—á ‚Äî V√©ra –±—É–¥–µ—Ç –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–≤–æ–¥–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ —Ü–∏–∫–ª–∞, –ª—É–Ω—ã –∏ –±–∏–æ—Ä–∏—Ç–º–æ–≤.</div>
    </div>
    <button class="btn btn-ai btn-sm mt12" onclick="generateDailyInsight()" id="insightBtn" style="display:none">‚ú¶ –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É</button>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CYCLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-cycle">
<div class="wrap">
  <div class="display" style="margin-bottom:6px">–ú–æ–π <em style="color:var(--rose)">—Ü–∏–∫–ª</em></div>
  <div class="muted" style="margin-bottom:22px">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é, —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–≤—É–ª—è—Ü–∏—é</div>

  <div class="card card-gold">
    <div class="flex gap8 spread" style="margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <div class="label" id="calMonthLabel"></div>
      <div class="flex gap8">
        <button class="btn btn-ghost btn-sm" onclick="changeMonth(-1)">‚Äπ</button>
        <button class="btn btn-ghost btn-sm" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
    </div>
    <div class="cal-hdr">
      <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div class="cal-legend mt12">
      <span><span class="ldot" style="background:rgba(212,120,138,.5)"></span>–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è</span>
      <span><span class="ldot" style="background:rgba(78,205,196,.4)"></span>–§–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ</span>
      <span><span class="ldot" style="background:rgba(201,168,76,.4)"></span>–û–≤—É–ª—è—Ü–∏—è</span>
      <span><span class="ldot" style="background:var(--fog)"></span>–ï—Å—Ç—å –∑–∞–ø–∏—Å—å</span>
    </div>
  </div>

  <div class="g2 mt8" style="margin-top:10px">
    <div class="card card-sm">
      <div class="label">–°–ª–µ–¥—É—é—â–∞—è</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--rose);margin:6px 0" id="cy-next">‚Äî</div>
      <div class="muted" style="font-size:11px" id="cy-nextsub">‚Äî</div>
    </div>
    <div class="card card-sm">
      <div class="label">–§–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ</div>
      <div style="font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--teal);margin:6px 0" id="cy-fertile">‚Äî</div>
      <div class="muted" style="font-size:11px" id="cy-fertsub">‚Äî</div>
    </div>
  </div>

  <div class="card mt8" style="margin-top:10px">
    <div class="label" style="margin-bottom:14px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–∏–∫–ª–∞</div>
    <div class="fgrid">
      <div class="field"><label>–ù–∞—á–∞–ª–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π</label><input type="date" id="cy-last"></div>
      <div class="field"><label>–î–ª–∏–Ω–∞ —Ü–∏–∫–ª–∞ (–¥–Ω–µ–π)</label><input type="number" id="cy-len" value="28" min="21" max="45"></div>
      <div class="field"><label>–î–ª–∏–Ω–∞ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏</label><input type="number" id="cy-dur" value="5" min="2" max="10"></div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="saveCycleSettings()">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <div class="card" style="margin-top:10px;border-color:rgba(212,120,138,.2)">
    <div class="label" style="margin-bottom:10px">–§–∞–∑–∞ –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</div>
    <div id="cyclePhaseCard"></div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-bio">
<div class="wrap">
  <div class="display" style="margin-bottom:6px">–ë–∏–æ—Ä–∏—Ç–º—ã</div>
  <div class="muted" style="margin-bottom:22px">–§–∏–∑–∏—á–µ—Å–∫–∏–π ¬∑ 23 –¥–Ω—è &nbsp;|&nbsp; –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π ¬∑ 28 –¥–Ω–µ–π &nbsp;|&nbsp; –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π ¬∑ 33 –¥–Ω—è</div>

  <div class="card card-gold">
    <div class="field">
      <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
      <input type="date" id="bio-dob" onchange="renderBio()">
    </div>
  </div>

  <div id="bioResult" style="display:none">
    <div class="card mt8" style="margin-top:10px">
      <div class="label" style="margin-bottom:16px">–°–µ–≥–æ–¥–Ω—è</div>
      <div id="bioBars"></div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="label" style="margin-bottom:12px">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</div>
      <div class="bio-week" id="bioWeek"></div>
    </div>

    <div class="card" id="bioAdviceCard" style="margin-top:10px"></div>
  </div>
  <div id="bioEmpty" class="card" style="margin-top:10px">
    <div class="muted" style="font-style:italic;text-align:center;padding:12px 0">–í–≤–µ–¥–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–∏–æ—Ä–∏—Ç–º–æ–≤</div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAROT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-tarot">
<div class="wrap">
  <div class="display" style="margin-bottom:6px">–ö–∞—Ä—Ç–∞ <em style="color:var(--gold2)">–¥–Ω—è</em></div>
  <div class="muted" style="margin-bottom:22px">–í—ã—Ç—è–Ω–∏ –∫–∞—Ä—Ç—É, –≤–≤–µ–¥–∏ –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Äî V√©ra –∏—Å—Ç–æ–ª–∫—É–µ—Ç</div>

  <div class="card card-gold" id="tarotTodaySection">
    <div class="label" style="margin-bottom:12px" id="tarotTodayLabel">–ö–∞—Ä—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
    <div id="tarotTodayDisplay">
      <div class="muted">–ï—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –Ω–∏–∂–µ.</div>
    </div>
    <div class="sep"></div>

    <div class="label" style="margin-bottom:10px">–í—ã–±—Ä–∞—Ç—å –∫–∞—Ä—Ç—É</div>
    <div class="field" style="margin-bottom:10px">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã</label>
      <input type="text" id="tarotInput" list="tarotList" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—É–Ω–∞, –ú–∏—Ä, –ú–∞–≥...">
      <datalist id="tarotList"></datalist>
    </div>
    <div class="field" style="margin-bottom:12px">
      <label>–ü–æ–∑–∏—Ü–∏—è</label>
      <select id="tarotReversed">
        <option value="upright">–ü—Ä—è–º–∞—è</option>
        <option value="reversed">–ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è</option>
      </select>
    </div>
    <div class="field" style="margin-bottom:12px">
      <label>–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="tarotQuestion" placeholder="–û —á—ë–º —Ç—ã –¥—É–º–∞–ª–∞, –∫–æ–≥–¥–∞ —Ç—è–Ω—É–ª–∞ –∫–∞—Ä—Ç—É?"></textarea>
    </div>
    <button class="btn btn-gold btn-w" onclick="interpretCard()">‚ú¶ –ò—Å—Ç–æ–ª–∫–æ–≤–∞—Ç—å</button>
  </div>

  <div id="tarotResult" style="display:none;margin-top:10px">
    <div class="tarot-card-display" id="tarotCardDisplay"></div>
    <div class="analysis-glow mt8" style="margin-top:10px">
      <div class="label" style="margin-bottom:12px">–¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ –æ—Ç V√©ra</div>
      <div id="tarotInterpText" class="insight-text"></div>
    </div>
  </div>

  <div class="card" style="margin-top:10px" id="tarotHistCard">
    <div class="label" style="margin-bottom:12px">–ò—Å—Ç–æ—Ä–∏—è –∫–∞—Ä—Ç</div>
    <div id="tarotHistory"></div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JOURNAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-journal">
<div class="wrap">
  <div class="display" style="margin-bottom:6px">–î–Ω–µ–≤–Ω–∏–∫</div>
  <div class="muted" style="margin-bottom:22px">–ó–∞–ø–∏—Å–∏, —Å–∏–º–ø—Ç–æ–º—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è</div>

  <div class="card card-gold">
    <div class="label" style="margin-bottom:10px">–ó–∞–ø–∏—Å–∞—Ç—å —Å–∏–º–ø—Ç–æ–º—ã</div>
    <div class="symp-row" id="journalSymptoms"></div>

    <div class="sep"></div>

    <div class="label" style="margin-bottom:8px">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
    <div class="symp-row" id="moodRow">
      <button class="spill" data-m="üòä" onclick="pickMood(this)">üòä –û—Ç–ª–∏—á–Ω–æ</button>
      <button class="spill" data-m="üôÇ" onclick="pickMood(this)">üôÇ –•–æ—Ä–æ—à–æ</button>
      <button class="spill" data-m="üòê" onclick="pickMood(this)">üòê –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ</button>
      <button class="spill" data-m="üòî" onclick="pickMood(this)">üòî –ì—Ä—É—Å—Ç–Ω–æ</button>
      <button class="spill" data-m="üò§" onclick="pickMood(this)">üò§ –†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ</button>
      <button class="spill" data-m="üò∞" onclick="pickMood(this)">üò∞ –¢—Ä–µ–≤–æ–≥–∞</button>
    </div>

    <div class="sep"></div>

    <div class="fgrid" style="margin:0 0 12px">
      <div class="field">
        <label>–°–æ–Ω (—á–∞—Å–æ–≤)</label>
        <input type="number" id="j-sleep" placeholder="7.5" min="0" max="24" step="0.5">
      </div>
      <div class="field">
        <label>–ë–æ–ª—å (0‚Äì10)</label>
        <input type="number" id="j-pain" placeholder="0" min="0" max="10">
      </div>
    </div>

    <div class="field" style="margin-bottom:12px">
      <label>–ó–∞–º–µ—Ç–∫–∞</label>
      <textarea id="j-note" placeholder="–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? –ö–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?"></textarea>
    </div>

    <button class="btn btn-gold btn-w" onclick="saveJournal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <div class="card" style="margin-top:10px" id="patternsCard">
    <div class="label" style="margin-bottom:12px">–ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–∏–º–ø—Ç–æ–º–æ–≤</div>
    <div id="patternsContent"><div class="muted">–ù–∞–∫–æ–ø–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π ‚Äî V√©ra –ø–æ–∫–∞–∂–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div></div>
  </div>

  <div id="journalList" style="margin-top:10px"></div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANALYSIS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-analysis">
<div class="wrap">
  <div class="display" style="margin-bottom:6px">–ê–Ω–∞–ª–∏–∑</div>
  <div class="muted" style="margin-bottom:22px">–í—Å–µ —Ü–∏–∫–ª—ã –≤–º–µ—Å—Ç–µ ‚Äî –ª—É–Ω–∞, —Ü–∏–∫–ª, –±–∏–æ—Ä–∏—Ç–º—ã, –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div>

  <div class="g3" id="analysisIndicators" style="margin-bottom:10px"></div>

  <div class="analysis-glow" style="margin-bottom:10px">
    <div class="label" style="margin-bottom:12px">‚ú¶ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</div>
    <!-- API is hardcoded ‚Äî no banner needed -->
    <div id="analysisInsight">
      <div class="insight-text muted">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ ‚Äî V√©ra –ø—Ä–æ–≤–µ–¥—ë—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ü–∏–∫–ª–æ–≤ –∏ –ø–æ–∫–∞–∂–µ—Ç —á—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Ç–≤–æ–∏–º —Ç–µ–ª–æ–º –∏ —ç–Ω–µ—Ä–≥–∏–µ–π.</div>
    </div>
    <button class="btn btn-gold mt12" onclick="runDeepAnalysis()" id="deepAnalysisBtn">‚ú¶ –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑</button>
  </div>

  <div class="card" style="margin-bottom:10px">
    <div class="label" style="margin-bottom:16px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤ ‚Äî 30 –¥–Ω–µ–π</div>
    <div id="syncChart"></div>
  </div>

  <div class="label" style="margin-bottom:10px">–°–ø—Ä–æ—Å–∏ V√©ra</div>
  <div class="chat-wrap">
    <div class="chat-messages" id="chatMessages">
      <div class="cmsg ai">
        <div class="cav">‚ú¶</div>
        <div class="cbub">–ü—Ä–∏–≤–µ—Ç! –Ø V√©ra ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–∞—à–∏–≤–∞–π –æ —Ü–∏–∫–ª–µ, —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏, –±–∏–æ—Ä–∏—Ç–º–∞—Ö, —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–∏ –∫–∞—Ä—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ —Ç–æ–º, –∫–∞–∫ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å üåô</div>
      </div>
    </div>
    <div class="chat-input-row">
      <input class="chat-in" id="chatInput" placeholder="–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å..." onkeydown="if(event.key==='Enter')sendChat()">
      <button class="btn btn-gold btn-sm" onclick="sendChat()">‚Üí</button>
    </div>
  </div>

</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-settings">
<div class="wrap">
  <div class="display" style="margin-bottom:22px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

  <div class="card card-gold">
    <div class="label" style="margin-bottom:14px">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="fgrid">
      <div class="field"><label>–ò–º—è</label><input id="s-name" type="text" placeholder="–¢–≤–æ—ë –∏–º—è"></div>
      <div class="field"><label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label><input id="s-dob" type="date" onchange="syncDob()"></div>
    </div>
    <button class="btn btn-gold btn-sm" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <div class="card" style="margin-top:10px;border-color:rgba(78,205,196,.15)">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <span style="font-size:22px">‚ú¶</span>
      <div>
        <div class="label" style="margin-bottom:3px">–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
        <div class="muted" style="font-size:12px">V√©ra —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Llama 3.3 70B</div>
      </div>
      <span style="margin-left:auto;font-size:18px" id="aiStatusDot">‚ö™</span>
    </div>
    <div id="aiTestResult" style="font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;border-radius:8px;background:var(--mid)"></div>
    <button class="btn btn-ai btn-sm" onclick="testAiConnection()">üß™ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="label" style="margin-bottom:12px">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</div>
    <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-style:italic;color:var(--gold2);margin-bottom:8px">V√©ra ‚ú¶</div>
    <div class="muted">–¢–≤–æ–π –ª–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞, –±–∏–æ—Ä–∏—Ç–º–æ–≤ –∏ —Ç–∞—Ä–æ. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–≤–æ—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</div>
    <div class="sep"></div>
    <button class="btn btn-ghost btn-sm" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?'))resetAll()" style="border-color:rgba(212,120,138,.3);color:var(--rose)">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
  </div>

</div>
</div>

<!-- MODALS -->
<div class="modal-bg" id="dayModal">
  <div class="modal">
    <div class="label" style="margin-bottom:14px" id="dayModalTitle">–î–µ–Ω—å</div>
    <div id="dayModalContent"></div>
    <div id="dayModalPeriodSection" style="display:none;margin-top:14px">
      <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(212,120,138,.3),transparent);margin-bottom:14px"></div>
      <div class="label" style="margin-bottom:10px">üå∏ –ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è</div>
      <div id="dayModalPeriodBtns" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
    <button class="btn btn-ghost btn-w mt12" onclick="closeDayModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê PWA Service Worker Registration ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
      self.addEventListener('install', e => {
        e.waitUntil(self.skipWaiting());
      });
      self.addEventListener('activate', e => {
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener('fetch', e => {
        e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
      });
    `)).then(reg => {
      console.log('SW registered:', reg);
    }).catch(err => {
      console.log('SW registration failed:', err);
    });
  });
}

// ‚ïê‚ïê‚ïê PWA Install Prompt ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(() => {
    document.getElementById('installPrompt')?.classList.add('show');
  }, 3000);
});

function installPWA() {
  document.getElementById('installPrompt')?.classList.remove('show');
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        console.log('PWA installed');
      }
      deferredPrompt = null;
    });
  }
}

function dismissInstall() {
  document.getElementById('installPrompt')?.classList.remove('show');
  localStorage.setItem('vera_install_dismissed', Date.now());
}

// Hide if dismissed recently
if (localStorage.getItem('vera_install_dismissed')) {
  const dismissed = parseInt(localStorage.getItem('vera_install_dismissed'));
  if (Date.now() - dismissed < 7 * 24 * 60 * 60 * 1000) {
    document.getElementById('installPrompt')?.classList.remove('show');
  }
}

// ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const storage = {
  async get(key) {
    try {
      const val = localStorage.getItem(key);
      return val !== null ? { value: val } : null;
    } catch (e) {
      return null;
    }
  },
  async set(key, value) {
    try {
      localStorage.setItem(key, value);
      return true;
    } catch (e) {
      return false;
    }
  }
};

// ‚ïê‚ïê‚ïê STORAGE KEYS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const K = {
  profile:  'vera_profile',
  cycle:    'vera_cycle',
  journal:  'vera_journal',
  tarot:    'vera_tarot',
  // apikey: removed ‚Äî hardcoded
  today:    'vera_today',
};

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let PROFILE  = { name:'', dob:'' };
let CYCLE    = { last:'', len:28, dur:5, history:[] };
let JOURNAL  = [];
let TAROT    = [];
// API key is in OR_KEY constant below
let TODAY    = {};
let selSymptoms = new Set();
let selMood  = '';
let calOffset = 0;

// ‚ïê‚ïê‚ïê ALL 78 TAROT CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAJOR = [
  {n:0,name:'–®—É—Ç',en:'The Fool',sym:'üÉè'},
  {n:1,name:'–ú–∞–≥',en:'The Magician',sym:'‚ú®'},
  {n:2,name:'–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞',en:'The High Priestess',sym:'üåô'},
  {n:3,name:'–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞',en:'The Empress',sym:'üåø'},
  {n:4,name:'–ò–º–ø–µ—Ä–∞—Ç–æ—Ä',en:'The Emperor',sym:'üëë'},
  {n:5,name:'–ò–µ—Ä–æ—Ñ–∞–Ω—Ç',en:'The Hierophant',sym:'üèõ'},
  {n:6,name:'–í–ª—é–±–ª—ë–Ω–Ω—ã–µ',en:'The Lovers',sym:'üíû'},
  {n:7,name:'–ö–æ–ª–µ—Å–Ω–∏—Ü–∞',en:'The Chariot',sym:'‚ö°'},
  {n:8,name:'–°–∏–ª–∞',en:'Strength',sym:'ü¶Å'},
  {n:9,name:'–û—Ç—à–µ–ª—å–Ω–∏–∫',en:'The Hermit',sym:'üïØ'},
  {n:10,name:'–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã',en:'Wheel of Fortune',sym:'‚òØ'},
  {n:11,name:'–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å',en:'Justice',sym:'‚öñ'},
  {n:12,name:'–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π',en:'The Hanged Man',sym:'üîÑ'},
  {n:13,name:'–°–º–µ—Ä—Ç—å',en:'Death',sym:'üåë'},
  {n:14,name:'–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å',en:'Temperance',sym:'üíß'},
  {n:15,name:'–î—å—è–≤–æ–ª',en:'The Devil',sym:'üîó'},
  {n:16,name:'–ë–∞—à–Ω—è',en:'The Tower',sym:'‚ö°'},
  {n:17,name:'–ó–≤–µ–∑–¥–∞',en:'The Star',sym:'‚≠ê'},
  {n:18,name:'–õ—É–Ω–∞',en:'The Moon',sym:'üåï'},
  {n:19,name:'–°–æ–ª–Ω—Ü–µ',en:'The Sun',sym:'‚òÄÔ∏è'},
  {n:20,name:'–°—É–¥',en:'Judgement',sym:'üé∫'},
  {n:21,name:'–ú–∏—Ä',en:'The World',sym:'üåç'},
];
const SUITS = ['–ñ–µ–∑–ª–æ–≤','–ö—É–±–∫–æ–≤','–ú–µ—á–µ–π','–ü–µ–Ω—Ç–∞–∫–ª–µ–π'];
const MINOR = [];
SUITS.forEach(s => {
  ['–¢—É–∑','2','3','4','5','6','7','8','9','10','–ü–∞–∂','–†—ã—Ü–∞—Ä—å','–ö–æ—Ä–æ–ª–µ–≤–∞','–ö–æ—Ä–æ–ª—å'].forEach((v,i) => {
    MINOR.push({ name: (i===0?'–¢—É–∑ ':v+' ') + s, sym: s==='–ö—É–±–∫–æ–≤'?'üèÜ':s==='–ñ–µ–∑–ª–æ–≤'?'üî•':s==='–ú–µ—á–µ–π'?'‚öî':s==='–ü–µ–Ω—Ç–∞–∫–ª–µ–π'?'üí∞':'üÉè' });
  });
});
const ALL_CARDS = [...MAJOR, ...MINOR];

// ‚ïê‚ïê‚ïê SYMPTOMS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SYMPTOMS = [
  { id:'migraine',  label:'ü§ï –ú–∏–≥—Ä–µ–Ω—å',    color:'#d4788a' },
  { id:'headache',  label:'üò£ –ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å', color:'#c46070' },
  { id:'tired',     label:'üò¥ –£—Å—Ç–∞–ª–æ—Å—Ç—å',   color:'#8884a0' },
  { id:'energy',    label:'‚ö° –ú–Ω–æ–≥–æ —Å–∏–ª',   color:'#c9a84c' },
  { id:'mood_good', label:'üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Üë', color:'#4ecdc4' },
  { id:'mood_bad',  label:'üòî –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Üì', color:'#7a6880' },
  { id:'cramps',    label:'üí¢ –°–ø–∞–∑–º—ã',      color:'#d4788a' },
  { id:'bloating',  label:'ü´† –í–∑–¥—É—Ç–∏–µ',     color:'#a09880' },
  { id:'insomnia',  label:'üåô –ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞',  color:'#6c63cc' },
  { id:'anxiety',   label:'üò∞ –¢—Ä–µ–≤–æ–≥–∞',     color:'#9a7890' },
  { id:'skin',      label:'‚ú® –ö–æ–∂–∞ –æ–∫',     color:'#c9a84c' },
  { id:'libido',    label:'üíï –õ–∏–±–∏–¥–æ ‚Üë',   color:'#e8909a' },
];

// ‚ïê‚ïê‚ïê MOON CALCULATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MOON_PHASES = [
  {name:'–ù–æ–≤–æ–ª—É–Ω–∏–µ',       sym:'üåë', days:[0,1]},
  {name:'–†–∞—Å—Ç—É—â–∏–π —Å–µ—Ä–ø',   sym:'üåí', days:[2,4]},
  {name:'–ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å', sym:'üåì', days:[5,7]},
  {name:'–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞',   sym:'üåî', days:[8,10]},
  {name:'–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ',      sym:'üåï', days:[11,14]},
  {name:'–£–±—ã–≤–∞—é—â–∞—è –ª—É–Ω–∞',  sym:'üåñ', days:[15,17]},
  {name:'–ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å',sym:'üåó',days:[18,21]},
  {name:'–£–±—ã–≤–∞—é—â–∏–π —Å–µ—Ä–ø',  sym:'üåò', days:[22,27]},
  {name:'–ù–æ–≤–æ–ª—É–Ω–∏–µ',       sym:'üåë', days:[28,29]},
];

function getMoonDay(date) {
  const ref = new Date(2025, 0, 29);
  const diff = Math.floor((date - ref) / 86400000);
  return ((diff % 29) + 29) % 29;
}

function getMoonPhase(date) {
  const day = getMoonDay(date);
  return MOON_PHASES.find(p => day >= p.days[0] && day <= p.days[1]) || MOON_PHASES[0];
}

// ‚ïê‚ïê‚ïê BIORHYTHMS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcBio(dob, date) {
  const days = Math.floor((date - dob) / 86400000);
  return {
    phys:  Math.sin(2 * Math.PI * days / 23),
    emot:  Math.sin(2 * Math.PI * days / 28),
    intel: Math.sin(2 * Math.PI * days / 33),
  };
}

// ‚ïê‚ïê‚ïê DATE HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseLocalDate(str) {
  if (!str) return null;
  const [y, m, d] = str.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function normalizeDate(date) {
  return new Date(date.getFullYear(), date.getMonth(), date.getDate());
}

function diffDays(a, b) {
  const ms = a - b;
  return Math.floor(ms / 86400000);
}

function fmtDate(d) {
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ‚ïê‚ïê‚ïê CYCLE CALC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCycleDay(date) {
  if (!CYCLE.last) return null;
  const last = parseLocalDate(CYCLE.last);
  if (!last) return null;
  const dateNorm = normalizeDate(date);
  const lastNorm = normalizeDate(last);
  const diff = diffDays(dateNorm, lastNorm);
  if (diff < 0) return null;
  const cycDay = (diff % CYCLE.len) + 1;
  return cycDay;
}

function getCyclePhase(cycDay) {
  if (!cycDay) return null;
  if (cycDay <= CYCLE.dur) return { name:'–ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–∞—è', color:'var(--rose)', text:'–í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –°–Ω–∏–∑—å –Ω–∞–≥—Ä—É–∑–∫—É, —Å–ª—É—à–∞–π —Ç–µ–ª–æ.' };
  if (cycDay <= 13) return { name:'–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è', color:'var(--teal)', text:'–≠–Ω–µ—Ä–≥–∏—è –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç. –û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.' };
  if (cycDay <= 16) return { name:'–û–≤—É–ª—è—Ü–∏—è', color:'var(--gold2)', text:'–ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Ö–∞—Ä–∏–∑–º—ã. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≤–∞–∂–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞.' };
  return { name:'–õ—é—Ç–µ–∏–Ω–æ–≤–∞—è', color:'var(--mist)', text:'–í–æ–∑–º–æ–∂–Ω—ã –ø–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –í—Ä–µ–º—è –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ –º—è–≥–∫–æ–π –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ.' };
}

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function boot() {
  try { const r = await storage.get(K.profile);  if(r) PROFILE  = JSON.parse(r.value); } catch(e){}
  try { const r = await storage.get(K.cycle);   if(r) CYCLE    = JSON.parse(r.value); } catch(e){}
  try { const r = await storage.get(K.journal);  if(r) JOURNAL  = JSON.parse(r.value); } catch(e){}
  try { const r = await storage.get(K.tarot);    if(r) TAROT    = JSON.parse(r.value); } catch(e){}
  // API_KEY is hardcoded ‚Äî no storage load needed
  try { const r = await storage.get(K.today);    if(r) TODAY    = JSON.parse(r.value); } catch(e){}

  if (!CYCLE.history) CYCLE.history = [];

  applyProfile();
  buildSymptomPills();
  buildTarotDatalist();
  renderToday();
  renderCycle();
  renderBio();
  renderTarotHistory();
  renderJournal();
  renderAnalysisIndicators();
})();

// ‚ïê‚ïê‚ïê PERSIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function save(key, val) {
  try { await storage.set(key, typeof val === 'string' ? val : JSON.stringify(val)); } catch(e){}
}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('on'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
    btn.classList.add('on');
    document.getElementById('page-' + btn.dataset.p).classList.add('on');
    if (btn.dataset.p === 'bio') renderBio();
    if (btn.dataset.p === 'analysis') { renderAnalysisIndicators(); renderSyncChart(); }
    if (btn.dataset.p === 'journal') renderPatterns();
  });
});
function go(p) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('on'));
  document.querySelectorAll('.page').forEach(pg => pg.classList.remove('on'));
  document.querySelector(`[data-p="${p}"]`).classList.add('on');
  document.getElementById('page-' + p).classList.add('on');
}

// ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyProfile() {
  if (PROFILE.name) {
    const n = document.getElementById('s-name'); if(n) n.value = PROFILE.name;
    const h = ['–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ','–î–æ–±—Ä—ã–π –¥–µ–Ω—å','–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä'];
    const hr = new Date().getHours();
    const greet = hr < 12 ? h[0] : hr < 18 ? h[1] : h[2];
    const el = document.getElementById('todayGreeting');
    if (el) el.textContent = greet + ', ' + PROFILE.name;
    const nel = document.getElementById('todayName');
    if (nel) nel.textContent = '';
  }
  if (PROFILE.dob) {
    const d = document.getElementById('s-dob'); if(d) d.value = PROFILE.dob;
    const b = document.getElementById('bio-dob'); if(b) { b.value = PROFILE.dob; renderBio(); }
  }
  if (CYCLE.last) {
    const c = document.getElementById('cy-last'); if(c) c.value = CYCLE.last;
    const l = document.getElementById('cy-len'); if(l) l.value = CYCLE.len;
    const d = document.getElementById('cy-dur'); if(d) d.value = CYCLE.dur;
  }
  // API hardcoded ‚Äî no key display needed
  const ib = document.getElementById('insightBtn');
  if (ib) ib.style.display = 'inline-flex';
}

function saveProfile() {
  PROFILE.name = document.getElementById('s-name')?.value.trim() || '';
  PROFILE.dob  = document.getElementById('s-dob')?.value || '';
  save(K.profile, PROFILE);
  applyProfile();
  toast('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

function syncDob() {
  const v = document.getElementById('s-dob')?.value;
  const b = document.getElementById('bio-dob');
  if (b && v) { b.value = v; renderBio(); }
}

// ‚ïê‚ïê‚ïê TODAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderToday() {
  const now = new Date();
  const dateEl = document.getElementById('todayDateLabel');
  if (dateEl) dateEl.textContent = now.toLocaleDateString('ru-RU', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

  if (!PROFILE.name) {
    const g = document.getElementById('todayGreeting');
    if (g) g.textContent = now.getHours() < 12 ? '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ' : now.getHours() < 18 ? '–î–æ–±—Ä—ã–π –¥–µ–Ω—å' : '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
  }

  const phase = getMoonPhase(now);
  setText('todayMoonEmoji', phase.sym);
  setText('todayMoonName', phase.name);
  setText('todayMoonDay', (getMoonDay(now) + 1) + ' –¥–µ–Ω—å –ª—É–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞');
  setText('navMoon', phase.sym);

  renderMoonStrip();

  const cycDay = getCycleDay(now);
  const cycPhase = getCyclePhase(cycDay);
  if (cycDay) {
    setText('todayCycleDay', cycDay);
    setText('todayCyclePhase', cycPhase?.name || '');
  } else {
       setText('todayCycleDay', '‚Äî');
    setText('todayCyclePhase', '–ù–∞—Å—Ç—Ä–æ–π —Ü–∏–∫–ª');
  }

  renderTodayBio();

  const todayStr = fmtDate(now);
  if (TODAY.date === todayStr) {
    if (TODAY.symptoms) TODAY.symptoms.forEach(s => selSymptoms.add(s));
    const es = document.getElementById('energySlider');
    if (es && TODAY.energy) { es.value = TODAY.energy; updateEnergy(); }
    const qn = document.getElementById('quickNote');
    if (qn && TODAY.note) qn.value = TODAY.note;
    refreshSymptomUi('quickSymptoms');
  }

  renderTodayTarot();
}

function renderTodayBio() {
  const bioCard = document.getElementById('todayBioCard');
  if (!PROFILE.dob) {
    if (bioCard) bioCard.style.display = 'none';
    return;
  }
  if (bioCard) bioCard.style.display = 'block';
  const bio = calcBio(new Date(PROFILE.dob), new Date());
  const items = [
    { l:'üí™ –§–∏–∑', v:bio.phys, c:'#d4788a' },
    { l:'üíú –≠–º–æ—Ü', v:bio.emot, c:'#9a80d4' },
    { l:'üß† –ò–Ω—Ç–µ–ª', v:bio.intel, c:'#4ecdc4' },
  ];
  const el = document.getElementById('todayBioMini');
  if (el) el.innerHTML = items.map(i => {
    const pct = Math.round(i.v * 50 + 50);
    const vt = (i.v > 0 ? '+' : '') + Math.round(i.v * 100) + '%';
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:7px">
      <span style="font-size:11px;min-width:70px;color:var(--mist)">${i.l}</span>
      <div style="flex:1;height:6px;background:var(--mid);border-radius:3px;position:relative;overflow:hidden">
        <div style="position:absolute;left:${Math.min(pct,50)}%;width:${Math.abs(pct-50)}%;height:100%;background:${i.c};border-radius:3px;"></div>
        <div style="position:absolute;left:50%;top:0;width:1px;height:100%;background:var(--border2)"></div>
      </div>
      <span style="font-size:11px;min-width:36px;text-align:right;color:${i.c}">${vt}</span>
    </div>`;
  }).join('');

  const criticals = [
    bio.phys < -0.8 ? '—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è' : null,
    bio.emot < -0.8 ? '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è' : null,
    bio.intel < -0.8 ? '–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è' : null,
  ].filter(Boolean);
  const bh = document.getElementById('todayBioHint');
  if (bh) bh.textContent = criticals.length ? '‚ö†Ô∏è –ù–∏–∑–∫–∞—è –∑–æ–Ω–∞: ' + criticals.join(', ') : '‚úì –ë–∏–æ—Ä–∏—Ç–º—ã –≤ –Ω–æ—Ä–º–µ';
}

function renderTodayTarot() {
  const today = fmtDate(new Date());
  const todayCard = TAROT.find(t => t.date === today);
  const el = document.getElementById('todayTarotContent');
  if (!el) return;
  if (todayCard) {
    el.innerHTML = `<div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:32px">${todayCard.sym || 'üÉè'}</div>
      <div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-style:italic;color:var(--gold2)">${todayCard.card}</div>
        <div style="font-size:11px;color:var(--mist);margin-top:2px">${todayCard.reversed ? '–ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è' : '–ü—Ä—è–º–∞—è'}</div>
      </div>
    </div>
    ${todayCard.interpretation ? `<div style="font-size:12px;color:var(--mist);margin-top:10px;line-height:1.65;font-style:italic">${todayCard.interpretation.slice(0,200)}...</div>` : ''}`;
  }
}

function renderMoonStrip() {
  const el = document.getElementById('moonStrip');
  if (!el) return;
  const today = normalizeDate(new Date());
  let html = '';
  for (let i = -3; i <= 3; i++) {
    const d = new Date(today); d.setDate(d.getDate() + i);
    const ph = getMoonPhase(d);
    const isToday = i === 0;
    const lbl = i === 0 ? '–°–µ–≥' : i === 1 ? '–ó–∞–≤—Ç' : d.toLocaleDateString('ru-RU',{weekday:'short'});
    html += `<div class="moon-day${isToday?' today':''}">
      <div class="mico">${ph.sym}</div>
      <div>${lbl}</div>
    </div>`;
  }
  el.innerHTML = html;
}

function updateEnergy() {
  const v = document.getElementById('energySlider')?.value;
  setText('energyVal', v);
}

// ‚ïê‚ïê‚ïê QUICK SYMPTOMS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSymptomPills() {
  ['quickSymptoms','journalSymptoms'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = SYMPTOMS.map(s =>
      `<button class="spill" data-id="${s.id}" onclick="toggleSymptom('${s.id}','${id}')">${s.label}</button>`
    ).join('');
  });
}

function toggleSymptom(id, containerId) {
  if (selSymptoms.has(id)) selSymptoms.delete(id);
  else selSymptoms.add(id);
  refreshSymptomUi(containerId);
}

function refreshSymptomUi(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.querySelectorAll('.spill[data-id]').forEach(btn => {
    btn.classList.toggle('on', selSymptoms.has(btn.dataset.id));
  });
}

function pickMood(btn) {
  document.querySelectorAll('#moodRow .spill').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  selMood = btn.dataset.m;
}

async function saveToday() {
  TODAY = {
    date: fmtDate(new Date()),
    symptoms: [...selSymptoms],
    energy: parseInt(document.getElementById('energySlider')?.value || 5),
    note: document.getElementById('quickNote')?.value.trim() || '',
  };
  await save(K.today, TODAY);
  toast('‚úÖ –î–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

// ‚ïê‚ïê‚ïê CYCLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let calYear, calMonth;

function renderCycle() {
  const now = new Date();
  if (calYear === undefined) { calYear = now.getFullYear(); calMonth = now.getMonth(); }

  const lbl = document.getElementById('calMonthLabel');
  if (lbl) lbl.textContent = new Date(calYear, calMonth).toLocaleDateString('ru-RU', {month:'long', year:'numeric'});

  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const firstDow = (new Date(calYear, calMonth, 1).getDay() + 6) % 7;
  const grid = document.getElementById('calGrid');
  if (!grid) return;

  let html = '';
  for (let i = 0; i < firstDow; i++) html += '<div></div>';
  
  for (let d = 1; d <= daysInMonth; d++) {
    const dt = new Date(calYear, calMonth, d);
    const isToday = d === now.getDate() && calMonth === now.getMonth() && calYear === now.getFullYear();
    const cycDay = getCycleDay(dt);
    const isPeriod = cycDay && cycDay <= CYCLE.dur;
    const isFertile = cycDay && cycDay >= CYCLE.len - 18 && cycDay <= CYCLE.len - 13;
    const isOvul = cycDay && cycDay === CYCLE.len - 14;
    const hasNote = JOURNAL.some(e => e.date === fmtDate(dt));
    const isHistStart = (CYCLE.history || []).some(h => h.start === fmtDate(dt));
    
    let cls = 'cday';
    if (isPeriod) cls += ' period';
    else if (isOvul) cls += ' ovulation';
    else if (isFertile) cls += ' fertile';
    if (isHistStart && !isPeriod) cls += ' period';
    if (isToday) cls += ' today';
    if (hasNote) cls += ' has-note';
    
    html += `<div class="${cls}" onclick="openDay('${fmtDate(dt)}')">${d}</div>`;
  }
  grid.innerHTML = html;

  if (CYCLE.last) {
    const todayCycDay = getCycleDay(now) || 1;
    const dToNext = CYCLE.len - todayCycDay + 1;
    setText('cy-next', dToNext <= 0 ? '–°–µ–π—á–∞—Å' : '—á–µ—Ä–µ–∑ ' + dToNext + ' –¥–Ω.');
    const nextDate = new Date(now); nextDate.setDate(nextDate.getDate() + dToNext);
    setText('cy-nextsub', nextDate.toLocaleDateString('ru-RU', {day:'numeric',month:'long'}));

    const dToFert = CYCLE.len - 18 - todayCycDay + 1;
    setText('cy-fertile', dToFert <= 0 ? '–°–µ–π—á–∞—Å' : '—á–µ—Ä–µ–∑ ' + dToFert + ' –¥–Ω.');
    const fertDate = new Date(now); fertDate.setDate(fertDate.getDate() + Math.max(0, dToFert));
    setText('cy-fertsub', fertDate.toLocaleDateString('ru-RU', {day:'numeric',month:'long'}));
  }

  const phase = getCyclePhase(getCycleDay(now));
  const pc = document.getElementById('cyclePhaseCard');
  if (pc && phase) {
    pc.innerHTML = `<div class="flex gap8" style="margin-bottom:8px">
      <span class="tag" style="background:rgba(255,255,255,.05);border:1px solid var(--border2);color:${phase.color}">${phase.name}</span>
      <span class="muted" style="font-size:12px">${getCycleDay(now)} –¥–µ–Ω—å —Ü–∏–∫–ª–∞</span>
    </div>
    <div class="muted">${phase.text}</div>`;
  } else if (pc) {
    pc.innerHTML = '<div class="muted">–£–∫–∞–∂–∏ –Ω–∞—á–∞–ª–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ü–∏–∫–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–∑—ã</div>';
  }
}

function changeMonth(dir) {
  calMonth += dir;
  if (calMonth < 0) { calMonth = 11; calYear--; }
  if (calMonth > 11) { calMonth = 0; calYear++; }
  renderCycle();
}

function saveCycleSettings() {
  CYCLE.last = document.getElementById('cy-last')?.value || '';
  CYCLE.len = parseInt(document.getElementById('cy-len')?.value || 28);
  CYCLE.dur = parseInt(document.getElementById('cy-dur')?.value || 5);
  save(K.cycle, CYCLE);
  renderCycle();
  renderToday();
  toast('‚úÖ –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª—ë–Ω');
}

function openDay(dateStr) {
  const entries = JOURNAL.filter(e => e.date === dateStr);
  const dt = parseLocalDate(dateStr);
  const cycDay = getCycleDay(dt);
  const moonPh = getMoonPhase(dt);
  
  const isCurrentPeriodStart = CYCLE.last === dateStr;
  const isHistoryStart = (CYCLE.history || []).some(h => h.start === dateStr);

  const title = document.getElementById('dayModalTitle');
  const content = document.getElementById('dayModalContent');
  if (!title || !content) return;
  
  title.textContent = dt.toLocaleDateString('ru-RU', {day:'numeric', month:'long', weekday:'long'});

  let html = `<div class="flex gap8 wrap-flex" style="margin-bottom:14px">
    <span class="tag tag-mist">${moonPh.sym} ${moonPh.name}</span>
    ${cycDay ? `<span class="tag tag-rose">${cycDay} –¥–µ–Ω—å —Ü–∏–∫–ª–∞</span>` : ''}
  </div>`;

  if (entries.length) {
    entries.forEach(e => {
      html += `<div class="entry">
        ${e.mood ? `<div style="font-size:22px;margin-bottom:8px">${e.mood}</div>` : ''}
        ${e.note ? `<div class="muted">${e.note}</div>` : ''}
        <div class="entry-pills">
          ${(e.symptoms || []).map(s => { const sym = SYMPTOMS.find(x => x.id === s); return sym ? `<span class="epill">${sym.label}</span>` : ''; }).join('')}
          ${e.sleep ? `<span class="epill">üåô ${e.sleep}—á</span>` : ''}
          ${e.pain ? `<span class="epill">üí¢ –±–æ–ª—å ${e.pain}/10</span>` : ''}
        </div>
      </div>`;
    });
  } else {
    html += '<div class="muted" style="font-style:italic;margin-bottom:4px">–ó–∞–ø–∏—Å–µ–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç</div>';
  }
  content.innerHTML = html;

  const periodSection = document.getElementById('dayModalPeriodSection');
  const periodBtns = document.getElementById('dayModalPeriodBtns');
  if (periodSection && periodBtns) {
    periodSection.style.display = 'block';

    if (isCurrentPeriodStart) {
      periodBtns.innerHTML = `
        <div style="width:100%;padding:10px 14px;background:rgba(212,120,138,.1);border:1px solid rgba(212,120,138,.25);border-radius:10px;display:flex;align-items:center;gap:10px;font-size:13px">
          <span style="font-size:18px">üå∏</span>
          <span style="color:var(--rose)">–ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞ –æ—Ç–º–µ—á–µ–Ω–æ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å</span>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="clearPeriodStart()" style="border-color:rgba(212,120,138,.3);color:var(--rose);width:100%;margin-top:4px">–£–±—Ä–∞—Ç—å –æ—Ç–º–µ—Ç–∫—É</button>`;
    } else {
      const today = normalizeDate(new Date());
      const isFuture = normalizeDate(dt) > today;
      
      periodBtns.innerHTML = `
        <button class="btn btn-rose btn-w" onclick="setPeriodStart('${dateStr}')" ${isFuture ? 'disabled style="opacity:.4;cursor:not-allowed"' : ''}>
          ü©∏ –ù–∞—á–∞–ª–∏—Å—å –º–µ—Å—è—á–Ω—ã–µ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
        </button>
        ${CYCLE.last ? `<div style="font-size:11px;color:var(--fog);width:100%;text-align:center;margin-top:4px">–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª –Ω–∞—á–∞–ª—Å—è: ${parseLocalDate(CYCLE.last).toLocaleDateString('ru-RU',{day:'numeric',month:'long'})}</div>` : ''}
        ${isHistoryStart ? `<div style="width:100%;padding:8px 14px;background:rgba(160,152,128,.08);border:1px solid rgba(160,152,128,.2);border-radius:10px;margin-top:6px;font-size:12px;color:var(--mist);display:flex;align-items:center;gap:8px"><span>üìÅ</span><span>–ù–∞—á–∞–ª–æ –ø—Ä–æ—à–ª–æ–≥–æ —Ü–∏–∫–ª–∞ (–≤ –∏—Å—Ç–æ—Ä–∏–∏)</span></div>` : ''}`;
    }
  }

  document.getElementById('dayModal').classList.add('on');
}

function setPeriodStart(dateStr) {
  if (!CYCLE.history) CYCLE.history = [];

  if (CYCLE.last && CYCLE.last !== dateStr) {
    // –°—á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –¥–ª–∏–Ω—É –ø—Ä–æ—à–ª–æ–≥–æ —Ü–∏–∫–ª–∞
    const prevStart = parseLocalDate(CYCLE.last);
    const newStart  = parseLocalDate(dateStr);
    const actualLen = diffDays(newStart, prevStart);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—à–ª—ã–π —Ü–∏–∫–ª –≤ –∏—Å—Ç–æ—Ä–∏—é —Å —Ä–µ–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω–æ–π
    const exists = CYCLE.history.some(h => h.start === CYCLE.last);
    if (!exists && actualLen > 0) {
      CYCLE.history.push({ start: CYCLE.last, len: actualLen });
    }

    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É —Ü–∏–∫–ª–∞ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 6 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
    const allLens = CYCLE.history
      .map(h => h.len)
      .filter(l => l && l >= 18 && l <= 60); // –∑–∞—â–∏—Ç–∞ –æ—Ç –º—É—Å–æ—Ä–∞
    if (allLens.length > 0) {
      const recent = allLens.slice(-6);
      const avg = Math.round(recent.reduce((a, b) => a + b, 0) / recent.length);
      CYCLE.len = avg;
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤ UI –µ—Å–ª–∏ –≤–∏–¥–Ω–æ
      const lenEl = document.getElementById('cy-len');
      if (lenEl) lenEl.value = avg;
    }
  }

  CYCLE.last = dateStr;

  save(K.cycle, CYCLE);
  closeDayModal();
  renderCycle();
  renderToday();

  const dt = parseLocalDate(dateStr);
  const newLen = CYCLE.len;
  toast('üå∏ –ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞: ' + dt.toLocaleDateString('ru-RU', {day:'numeric', month:'long'}) + ' ¬∑ —Ü–∏–∫–ª ' + newLen + ' –¥–Ω.');
}

function clearPeriodStart() {
  if (CYCLE.history && CYCLE.history.length > 0) {
    CYCLE.history.sort((a, b) => new Date(b.start) - new Date(a.start));
    const prev = CYCLE.history.shift();
    CYCLE.last = prev.start;
  } else {
    CYCLE.last = '';
  }
  
  save(K.cycle, CYCLE);
  closeDayModal();
  renderCycle();
  renderToday();
  
  toast(CYCLE.last ? '‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ü–∏–∫–ª' : '–û—Ç–º–µ—Ç–∫–∞ —É–±—Ä–∞–Ω–∞');
}

function closeDayModal() { 
  document.getElementById('dayModal').classList.remove('on'); 
}

document.getElementById('dayModal').addEventListener('click', function(e) { 
  if (e.target === this) closeDayModal(); 
});

// ‚ïê‚ïê‚ïê BIORHYTHMS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBio() {
  const dobEl = document.getElementById('bio-dob');
  const res = document.getElementById('bioResult');
  const emp = document.getElementById('bioEmpty');
  if (!dobEl?.value) { if(res) res.style.display='none'; if(emp) emp.style.display='block'; return; }
  if(res) res.style.display='block'; if(emp) emp.style.display='none';

  const dob = new Date(dobEl.value);
  const now = new Date();
  const bio = calcBio(dob, now);

  const items = [
    { l:'üí™ –§–∏–∑–∏—á–µ—Å–∫–∏–π', v:bio.phys, c:'#d4788a', p:23 },
    { l:'üíú –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π', v:bio.emot, c:'#9a80d4', p:28 },
    { l:'üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π', v:bio.intel, c:'#4ecdc4', p:33 },
  ];

  const bb = document.getElementById('bioBars');
  if (bb) bb.innerHTML = items.map(i => {
    const pct = Math.round(i.v * 50 + 50);
    const vt = (i.v > 0 ? '+' : '') + Math.round(i.v * 100) + '%';
    const isCrit = Math.abs(i.v) < 0.15;
    return `<div class="bio-row">
      <div class="bio-label">${i.l}</div>
      <div class="bio-track">
        <div class="bio-zero"></div>
        <div class="bio-fill" style="left:${Math.min(pct,50)}%;width:${Math.abs(pct-50)}%;background:${isCrit?'var(--gold)':i.c}"></div>
      </div>
      <div class="bio-val" style="color:${isCrit?'var(--gold)':i.c}">${vt}</div>
    </div>
    ${isCrit ? `<div style="font-size:10px;color:var(--gold);margin:-8px 0 8px 94px;letter-spacing:.05em">‚ö† –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ù–¨</div>` : ''}`;
  }).join('');

  const wk = document.getElementById('bioWeek');
  if (wk) {
    wk.innerHTML = Array.from({length:7}, (_,i) => {
      const fd = new Date(now); fd.setDate(fd.getDate() + i - 3);
      const b = calcBio(dob, fd);
      const avg3 = (b.phys + b.emot + b.intel) / 3;
      const c = avg3 > 0.3 ? 'var(--teal)' : avg3 < -0.3 ? 'var(--rose)' : 'var(--gold)';
      const lbl = i===3 ? '–°–µ–≥' : fd.toLocaleDateString('ru-RU',{weekday:'short'});
      return `<div class="bw-day${i===3?' today':''}">
        <div class="bw-lbl">${lbl}</div>
        <div class="bw-val" style="color:${c}">${avg3>0?'+':''}${Math.round(avg3*100)}</div>
      </div>`;
    }).join('');
  }

  const adv = document.getElementById('bioAdviceCard');
  if (adv) {
    const criticals = items.filter(i => Math.abs(i.v) < 0.15).map(i => i.l.split(' ')[1]);
    const highs = items.filter(i => i.v > 0.6).map(i => i.l.split(' ')[1]);
    let html = '';
    if (criticals.length) html += `<div style="background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:14px;margin-bottom:8px"><strong style="color:var(--gold2)">‚ö† –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–Ω–∏</strong><p class="muted" style="margin-top:5px">–°—Ñ–µ—Ä—ã: ${criticals.join(', ')}. –ü–æ–≤—ã—à–µ–Ω —Ä–∏—Å–∫ –æ—à–∏–±–æ–∫. –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞.</p></div>`;
    if (highs.length) html += `<div style="background:rgba(78,205,196,.06);border:1px solid rgba(78,205,196,.18);border-radius:12px;padding:14px;margin-bottom:8px"><strong style="color:var(--teal)">‚ú® –ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏</strong><p class="muted" style="margin-top:5px">${highs.join(', ')} ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª!</p></div>`;
    if (!html) html = `<div style="background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:14px"><strong>–°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</strong><p class="muted" style="margin-top:5px">–ë–∏–æ—Ä–∏—Ç–º—ã –≤ —Å—Ä–µ–¥–Ω–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ. –•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–ª–∞–Ω–æ–º–µ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã.</p></div>`;
    adv.innerHTML = html;
  }
}

// ‚ïê‚ïê‚ïê TAROT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildTarotDatalist() {
  const dl = document.getElementById('tarotList');
  if (!dl) return;
  dl.innerHTML = ALL_CARDS.map(c => `<option value="${c.name}">`).join('');
}

async function interpretCard() {
  const name = document.getElementById('tarotInput')?.value.trim();
  if (!name) { toast('‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã'); return; }
  const reversed = document.getElementById('tarotReversed')?.value === 'reversed';
  const question = document.getElementById('tarotQuestion')?.value.trim() || '';

  const card = ALL_CARDS.find(c => c.name.toLowerCase() === name.toLowerCase()) || { name, sym:'üÉè' };
  const today = fmtDate(new Date());

  const display = document.getElementById('tarotCardDisplay');
  if (display) display.innerHTML = `
    <div class="tarot-symbol">${card.sym}</div>
    <div class="tarot-num">${card.n !== undefined ? '–ê–†–ö–ê–ù ' + card.n : '–ú–õ–ê–î–®–ò–ô –ê–†–ö–ê–ù'}</div>
    <div class="tarot-name-big">${card.name}${reversed ? ' (–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' : ''}</div>
    ${question ? `<div class="muted" style="font-size:12px;margin-top:8px;font-style:italic">"${question}"</div>` : ''}
  `;

  const resultEl = document.getElementById('tarotResult');
  if (resultEl) resultEl.style.display = 'block';

  const interpEl = document.getElementById('tarotInterpText');
  if (interpEl) interpEl.innerHTML = '<div class="dot-pulse"><span></span><span></span><span></span></div>';

  let interpretation = '';
  if (API_KEY) {
    const cycDay = getCycleDay(new Date());
    const moonPh = getMoonPhase(new Date());
    const bioStr = PROFILE.dob ? (() => {
      const b = calcBio(new Date(PROFILE.dob), new Date());
      return `–ë–∏–æ—Ä–∏—Ç–º—ã: —Ñ–∏–∑ ${Math.round(b.phys*100)}%, —ç–º–æ—Ü ${Math.round(b.emot*100)}%, –∏–Ω—Ç–µ–ª ${Math.round(b.intel*100)}%`;
    })() : '';

    const prompt = `–¢—ã V√©ra ‚Äî –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –î–∞–π –ø–æ—ç—Ç–∏—á–µ—Å–∫–æ–µ, –Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ.

–ö–∞—Ä—Ç–∞: ${card.name} ${reversed ? '(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' : '(–ø—Ä—è–º–∞—è)'}
${question ? '–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + question : ''}
${cycDay ? '–î–µ–Ω—å —Ü–∏–∫–ª–∞: ' + cycDay + ' (' + getCyclePhase(cycDay)?.name + ')' : ''}
–õ—É–Ω–∞: ${moonPh.name}
${bioStr}

–î–∞–π —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –≤ 3‚Äì4 –∞–±–∑–∞—Ü–∞—Ö: —Å–Ω–∞—á–∞–ª–∞ —Å—É—Ç—å –∫–∞—Ä—Ç—ã —Å–µ–≥–æ–¥–Ω—è, –∑–∞—Ç–µ–º –∫–∞–∫ –æ–Ω–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (—Ü–∏–∫–ª, –ª—É–Ω–∞, –±–∏–æ—Ä–∏—Ç–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å), –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏. –ì–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ, –∫–∞–∫ –º—É–¥—Ä–∞—è –ø–æ–¥—Ä—É–≥–∞. –ë–µ–∑ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞.`;

    interpretation = await callAI(prompt, 600) || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ.';
  } else {
    interpretation = getFallbackInterpretation(card, reversed);
  }

  if (interpEl) interpEl.innerHTML = interpretation.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  const entry = { id:Date.now(), date:today, card:card.name, sym:card.sym, reversed, question, interpretation };
  TAROT = TAROT.filter(t => t.date !== today);
  TAROT.unshift(entry);
  await save(K.tarot, TAROT);
  renderTarotHistory();
  renderTodayTarot();
  toast('‚úÖ –ö–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
}

function getFallbackInterpretation(card, reversed) {
  const fallbacks = {
    '–õ—É–Ω–∞': '–õ—É–Ω–∞ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–∞–π–Ω–∞—Ö, –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ —Ç–æ–º, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ –ø–æ–¥ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å—é. –°–µ–≥–æ–¥–Ω—è –¥–æ–≤–µ—Ä—è–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –≥–æ–ª–æ—Å—É –±–æ–ª—å—à–µ, —á–µ–º –ª–æ–≥–∏–∫–µ.',
    '–°–æ–ª–Ω—Ü–µ': '–≠–Ω–µ—Ä–≥–∏—è, —Ä–∞–¥–æ—Å—Ç—å –∏ —è—Å–Ω–æ—Å—Ç—å. –ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –¥–µ–Ω—å —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤–æ–π.',
    '–ó–≤–µ–∑–¥–∞': '–ü–æ—Å–ª–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞–¥–µ–∂–¥–∞. –≠—Ç–æ –∫–∞—Ä—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –≤–µ—Ä—ã –≤ –ª—É—á—à–µ–µ. –¢—ã –Ω–∞ –≤–µ—Ä–Ω–æ–º –ø—É—Ç–∏.',
  };
  const base = fallbacks[card.name] || `${card.name} ‚Äî –º–æ—â–Ω–∞—è –∫–∞—Ä—Ç–∞, –Ω–µ—Å—É—â–∞—è –≤–∞–∂–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç —Ç–≤–æ—ë –≤–Ω–∏–º–∞–Ω–∏–µ.`;
  return (reversed ? '–ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∑–≥–ª—è–Ω—É—Ç—å –≤–Ω—É—Ç—Ä—å. ' : '') + base + '\n\n(–î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å —É—á—ë—Ç–æ–º —Ü–∏–∫–ª–∞ –∏ –±–∏–æ—Ä–∏—Ç–º–æ–≤ –¥–æ–±–∞–≤—å API –∫–ª—é—á –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)';
}

function renderTarotHistory() {
  const el = document.getElementById('tarotHistory');
  if (!el) return;
  if (!TAROT.length) { el.innerHTML = '<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
  el.innerHTML = TAROT.slice(0,7).map(t => {
    const d = parseLocalDate(t.date);
    const isToday = t.date === fmtDate(new Date());
    return `<div class="entry">
      <div class="entry-head">
        <span style="font-size:12px;color:var(--mist)">${d.toLocaleDateString('ru-RU',{day:'numeric',month:'short',weekday:'short'})}</span>
        ${isToday ? '<span class="tag tag-gold" style="font-size:10px">–°–µ–≥–æ–¥–Ω—è</span>' : ''}
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:24px">${t.sym||'üÉè'}</span>
        <div>
          <div style="font-family:'Cormorant Garamond',serif;font-size:16px;font-style:italic;color:var(--gold2)">${t.card}${t.reversed?' ‚ÜôÔ∏è':''}</div>
          ${t.interpretation ? `<div style="font-size:11px;color:var(--mist);margin-top:3px;line-height:1.5">${t.interpretation.slice(0,120)}...</div>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê JOURNAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveJournal() {
  const now = new Date();
  const entry = {
    id: Date.now(),
    date: fmtDate(now),
    symptoms: [...selSymptoms],
    mood: selMood,
    sleep: parseFloat(document.getElementById('j-sleep')?.value) || null,
    pain: parseInt(document.getElementById('j-pain')?.value) || null,
    note: document.getElementById('j-note')?.value.trim() || '',
    cycleDay: getCycleDay(now),
    moonPhase: getMoonPhase(now).name,
    bio: PROFILE.dob ? calcBio(new Date(PROFILE.dob), now) : null,
  };
  JOURNAL.unshift(entry);
  await save(K.journal, JOURNAL);
  renderJournal();
  renderPatterns();
  renderCycle();

  selSymptoms.clear(); selMood = '';
  buildSymptomPills();
  document.querySelectorAll('#moodRow .spill').forEach(b => b.classList.remove('on'));
  ['j-sleep','j-pain','j-note'].forEach(id => { const e = document.getElementById(id); if(e) e.value = ''; });
  toast('‚úÖ –ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
}

function renderJournal() {
  const el = document.getElementById('journalList');
  if (!el) return;
  if (!JOURNAL.length) { el.innerHTML = '<div class="muted" style="text-align:center;padding:20px">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
  el.innerHTML = JOURNAL.slice(0,20).map(e => {
    const d = parseLocalDate(e.date);
    const ph = getMoonPhase(d);
    return `<div class="entry">
      <div class="entry-head">
        <span style="font-size:12px;color:var(--mist)">${d.toLocaleDateString('ru-RU',{weekday:'short',day:'numeric',month:'short'})}</span>
        <span>${e.mood||''}</span>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
        <span class="tag tag-mist">${ph.sym} ${e.moonPhase||ph.name}</span>
        ${e.cycleDay ? `<span class="tag tag-rose">${e.cycleDay} –¥.—Ü.</span>` : ''}
      </div>
      ${e.note ? `<div class="muted" style="font-size:13px">${e.note}</div>` : ''}
      <div class="entry-pills">
        ${(e.symptoms||[]).map(s => { const sym = SYMPTOMS.find(x=>x.id===s); return sym?`<span class="epill">${sym.label}</span>`:''; }).join('')}
        ${e.sleep?`<span class="epill">üåô ${e.sleep}—á</span>`:''}
        ${e.pain?`<span class="epill">üí¢ ${e.pain}/10</span>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderPatterns() {
  const el = document.getElementById('patternsContent');
  if (!el || JOURNAL.length < 5) return;
  const counts = {};
  JOURNAL.forEach(e => (e.symptoms||[]).forEach(s => { counts[s] = (counts[s]||0) + 1; }));
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,6);
  if (!sorted.length) return;
  const max = sorted[0][1];
  el.innerHTML = sorted.map(([id, cnt]) => {
    const sym = SYMPTOMS.find(s => s.id === id);
    const pct = Math.round(cnt / max * 100);
    const days = JOURNAL.filter(e => e.symptoms?.includes(id) && e.cycleDay).map(e => e.cycleDay);
    const avgDay = days.length ? Math.round(days.reduce((a,b)=>a+b,0)/days.length) : null;
    return `<div class="pattern-row">
      <span style="min-width:120px;font-size:12px">${sym?.label||id}</span>
      <div class="pattern-bar"><div class="pattern-fill" style="width:${pct}%"></div></div>
      <span style="min-width:28px;font-size:11px;color:var(--mist)">${cnt}√ó</span>
      ${avgDay ? `<span style="font-size:10px;color:var(--fog)">~${avgDay}–¥.—Ü.</span>` : ''}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê ANALYSIS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAnalysisIndicators() {
  const el = document.getElementById('analysisIndicators');
  if (!el) return;
  const now = new Date();
  const moonPh = getMoonPhase(now);
  const cycDay = getCycleDay(now);
  const phase = getCyclePhase(cycDay);
  const bio = PROFILE.dob ? calcBio(new Date(PROFILE.dob), now) : null;
  const avgBio = bio ? ((bio.phys + bio.emot + bio.intel) / 3) : null;

  el.innerHTML = [
    { ico:moonPh.sym, lbl:'–õ—É–Ω–∞', val:moonPh.name, sub:(getMoonDay(now)+1)+' –¥–µ–Ω—å', c:'var(--gold2)' },
    { ico:'üå∏', lbl:'–¶–∏–∫–ª', val:cycDay ? cycDay+' –¥–µ–Ω—å' : '‚Äî', sub:phase?.name||'–ù–∞—Å—Ç—Ä–æ–π —Ü–∏–∫–ª', c:'var(--rose)' },
    { ico:'üåä', lbl:'–ë–∏–æ—Ä–∏—Ç–º—ã', val:avgBio !== null ? (avgBio>0?'+':'')+Math.round(avgBio*100)+'%' : '‚Äî', sub:avgBio!==null?(avgBio>0.3?'–ü–æ–¥—ä—ë–º':avgBio<-0.3?'–°–ø–∞–¥':'–ù–æ—Ä–º–∞'):'–£–∫–∞–∂–∏ –¥.—Ä.', c:'var(--teal)' },
  ].map(i => `<div class="card card-sm center">
    <div style="font-size:26px;margin-bottom:6px">${i.ico}</div>
    <div class="label" style="margin-bottom:4px">${i.lbl}</div>
    <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:500;color:${i.c}">${i.val}</div>
    <div class="muted" style="font-size:11px;margin-top:2px">${i.sub}</div>
  </div>`).join('');

  const banner = document.getElementById('analysisApiKeyBanner');
  if (banner) banner.style.display = API_KEY ? 'none' : 'block';
}

function renderSyncChart() {
  const el = document.getElementById('syncChart');
  if (!el) return;
  const now = new Date();
  const days = 30;
  const dobDate = PROFILE.dob ? new Date(PROFILE.dob) : null;

  let rows = '';
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(now); d.setDate(d.getDate() - i);
    const moonDay = getMoonDay(d);
    const moonPct = moonDay / 29 * 100;
    const cycDay2 = getCycleDay(d);
    const cycPct = cycDay2 ? (cycDay2 / CYCLE.len * 100) : 0;
    const bio = dobDate ? calcBio(dobDate, d) : null;
    const avgBio2 = bio ? (bio.phys + bio.emot + bio.intel) / 3 : 0;
    const bioPct = (avgBio2 + 1) / 2 * 100;
    const isToday = i === 0;

    rows += `<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px;${isToday?'background:var(--soft);border-radius:6px;padding:2px 4px':''}">
      <span style="font-size:9px;min-width:24px;color:var(--fog)">${d.getDate()}</span>
      <div style="flex:1;height:4px;background:var(--mid);border-radius:2px;overflow:hidden">
        <div style="width:${moonPct}%;height:100%;background:var(--gold);opacity:.6;border-radius:2px"></div>
      </div>
      <div style="flex:1;height:4px;background:var(--mid);border-radius:2px;overflow:hidden">
        <div style="width:${cycPct}%;height:100%;background:var(--rose);opacity:.7;border-radius:2px"></div>
      </div>
      ${dobDate ? `<div style="flex:1;height:4px;background:var(--mid);border-radius:2px;overflow:hidden">
        <div style="width:${bioPct}%;height:100%;background:var(--teal);opacity:.6;border-radius:2px"></div>
      </div>` : ''}
    </div>`;
  }

  el.innerHTML = `<div style="display:flex;gap:4px;font-size:10px;color:var(--fog);margin-bottom:8px">
    <span style="min-width:28px"></span>
    <span style="flex:1">üåô –õ—É–Ω–∞</span>
    <span style="flex:1">üå∏ –¶–∏–∫–ª</span>
    ${dobDate ? '<span style="flex:1">üåä –ë–∏–æ—Ä–∏—Ç–º</span>' : ''}
  </div>${rows}`;
}

async function runDeepAnalysis() {
  const el = document.getElementById('analysisInsight');
  if (el) el.innerHTML = '<div class="dot-pulse"><span></span><span></span><span></span></div>';

  const now = new Date();
  const moonPh = getMoonPhase(now);
  const cycDay = getCycleDay(now);
  const phase = getCyclePhase(cycDay);
  const bio = PROFILE.dob ? calcBio(new Date(PROFILE.dob), now) : null;
  const recentSymptoms = JOURNAL.slice(0,7).flatMap(e => e.symptoms||[]);
  const symptomCounts = {};
  recentSymptoms.forEach(s => symptomCounts[s] = (symptomCounts[s]||0)+1);
  const topSymptoms = Object.entries(symptomCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([id]) => SYMPTOMS.find(s=>s.id===id)?.label||id);
  const todayTarot = TAROT.find(t => t.date === fmtDate(now));

  const prompt = `–¢—ã V√©ra ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–î–ê–ù–ù–´–ï –°–ï–ì–û–î–ù–Ø:
- –õ—É–Ω–∞: ${moonPh.name} (${getMoonDay(now)+1} –¥–µ–Ω—å –ª—É–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞)
- –ú–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª: ${cycDay ? cycDay + ' –¥–µ–Ω—å, —Ñ–∞–∑–∞: ' + phase?.name : '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}
- –ë–∏–æ—Ä–∏—Ç–º—ã: ${bio ? `—Ñ–∏–∑ ${Math.round(bio.phys*100)}%, —ç–º–æ—Ü ${Math.round(bio.emot*100)}%, –∏–Ω—Ç–µ–ª ${Math.round(bio.intel*100)}%` : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥.—Ä.'}
- –ß–∞—Å—Ç—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –∑–∞ 7 –¥–Ω–µ–π: ${topSymptoms.join(', ') || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
- –ö–∞—Ä—Ç–∞ –¥–Ω—è: ${todayTarot ? todayTarot.card + (todayTarot.reversed?' (–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)':'') : '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞'}

–ù–∞–ø–∏—à–∏ –∞–Ω–∞–ª–∏–∑ –≤ 4 —á–∞—Å—Ç—è—Ö:
1. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤** ‚Äî –∫–∞–∫ –ª—É–Ω–∞, —Ü–∏–∫–ª –∏ –±–∏–æ—Ä–∏—Ç–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å–µ–≥–æ–¥–Ω—è
2. **–¢–µ–ª–æ –∏ —ç–Ω–µ—Ä–≥–∏—è** ‚Äî —á—Ç–æ –æ–∂–∏–¥–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
3. **–°–æ–≤–µ—Ç –Ω–∞ –¥–µ–Ω—å** ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —Ç–µ–ø–ª–æ, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ
4. **–ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ** ‚Äî –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç

–ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –º—É–¥—Ä–∞—è, —Ç—ë–ø–ª–∞—è –ø–æ–¥—Ä—É–≥–∞. –ù–µ –±–æ–ª–µ–µ 350 —Å–ª–æ–≤.`;

  const result = await callAI(prompt, 800);
  if (el) el.innerHTML = (result || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑').replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
}

async function generateDailyInsight() {
  const el = document.getElementById('todayInsightContent');
  if (el) el.innerHTML = '<div class="dot-pulse"><span></span><span></span><span></span></div>';

  const now = new Date();
  const moonPh = getMoonPhase(now);
  const cycDay = getCycleDay(now);
  const phase = getCyclePhase(cycDay);
  const bio = PROFILE.dob ? calcBio(new Date(PROFILE.dob), now) : null;

  const prompt = `–¢—ã V√©ra. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é —É—Ç—Ä–µ–Ω–Ω—é—é —Å–≤–æ–¥–∫—É (2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –¥–ª—è ${PROFILE.name||'–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}.

–õ—É–Ω–∞: ${moonPh.name}. –¶–∏–∫–ª: ${cycDay ? cycDay+' –¥–µ–Ω—å, '+phase?.name : '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}. ${bio ? `–ë–∏–æ—Ä–∏—Ç–º—ã: –æ–±—â–∏–π ${Math.round(((bio.phys+bio.emot+bio.intel)/3)*100)}%` : ''}

–¢–µ–ø–ª–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –±–µ–∑ –º–∏—Å—Ç–∏–∫–∏. –û–¥–∏–Ω –∫–ª—é—á–µ–≤–æ–π —Å–æ–≤–µ—Ç –Ω–∞ –¥–µ–Ω—å.`;

  const result = await callAI(prompt, 200);
  if (el) el.innerHTML = `<div class="insight-text">${(result||'').replace(/\n/g,'<br>')}</div>`;
}

// ‚ïê‚ïê‚ïê AI CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendChat() {
  const inp = document.getElementById('chatInput');
  const txt = inp?.value.trim();
  if (!txt) return;
  inp.value = '';


  addChatMsg('user', txt);
  const tid = addTyping();

  const now = new Date();
  const moonPh = getMoonPhase(now);
  const cycDay = getCycleDay(now);
  const phase = getCyclePhase(cycDay);
  const bio = PROFILE.dob ? calcBio(new Date(PROFILE.dob), now) : null;

  const system = `–¢—ã V√©ra ‚Äî —Ç—ë–ø–ª—ã–π, –º—É–¥—Ä—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∂–µ–Ω—â–∏–Ω. –ì–æ–≤–æ—Ä–∏—à—å –ø–æ-—Ä—É—Å—Å–∫–∏. –û—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏, —Ü–∏–∫–ª–µ, –±–∏–æ—Ä–∏—Ç–º–∞—Ö, –∫–∞—Ä—Ç–∞—Ö –¢–∞—Ä–æ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- –ò–º—è: ${PROFILE.name||'–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- –õ—É–Ω–∞: ${moonPh.name}, ${getMoonDay(now)+1} –¥–µ–Ω—å
- –¶–∏–∫–ª: ${cycDay ? cycDay+' –¥–µ–Ω—å, '+phase?.name : '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}
- –ë–∏–æ—Ä–∏—Ç–º—ã: ${bio ? `—Ñ–∏–∑ ${Math.round(bio.phys*100)}%, —ç–º–æ—Ü ${Math.round(bio.emot*100)}%, –∏–Ω—Ç–µ–ª ${Math.round(bio.intel*100)}%` : '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã'}
- –ó–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ: ${JOURNAL.length}

–û—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –¥–æ 150 —Å–ª–æ–≤.`;

  const result = await callAI(txt, 400, system);
  removeTyping(tid);
  addChatMsg('ai', result || 'üòî –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
}

function addChatMsg(role, text) {
  const box = document.getElementById('chatMessages');
  if (!box) return;
  const div = document.createElement('div');
  div.className = 'cmsg ' + role;
  div.innerHTML = `<div class="cav">${role==='ai'?'‚ú¶':'üå∏'}</div><div class="cbub">${text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}</div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function addTyping() {
  const id = 'typ' + Date.now();
  const box = document.getElementById('chatMessages');
  if (!box) return id;
  const div = document.createElement('div');
  div.className = 'cmsg ai'; div.id = id;
  div.innerHTML = `<div class="cav">‚ú¶</div><div class="cbub"><div class="dot-pulse"><span></span><span></span><span></span></div></div>`;
  box.appendChild(div); box.scrollTop = box.scrollHeight;
  return id;
}

function removeTyping(id) { 
  document.getElementById(id)?.remove(); 
}

// ‚ïê‚ïê‚ïê AI API CALL (OpenRouter via corsproxy.io) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const OR_KEY = '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';
const OR_URL = 'https://corsproxy.io/?url=' + encodeURIComponent('https://openrouter.ai/api/v1/chat/completions');

async function callAI(prompt, maxTokens = 500, systemOverride = null) {
  try {
    const messages = [];
    if (systemOverride) messages.push({ role: 'system', content: systemOverride });
    messages.push({ role: 'user', content: prompt });

    const res = await fetch(OR_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + OR_KEY,
      },
      body: JSON.stringify({
        model: 'meta-llama/llama-3.3-70b-instruct:free',
        max_tokens: maxTokens,
        messages: messages
      })
    });

    if (!res.ok) {
      const errText = await res.text();
      console.error('OR error:', res.status, errText);
      toast('‚ö†Ô∏è –ò–ò: –æ—à–∏–±–∫–∞ ' + res.status);
      return null;
    }

    const data = await res.json();
    const text = data.choices?.[0]?.message?.content;
    if (!text) {
      console.error('OR empty:', JSON.stringify(data));
      return null;
    }
    return text;
  } catch (e) {
    console.error('callAI:', e);
    toast('‚ö†Ô∏è –ù–µ—Ç —Å–≤—è–∑–∏: ' + e.message);
    return null;
  }
}



// ‚ïê‚ïê‚ïê AI CONNECTION TEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function testAiConnection() {
  const dot = document.getElementById('aiStatusDot');
  const res = document.getElementById('aiTestResult');
  if (dot) dot.textContent = 'üü°';
  if (res) { res.style.display = 'block'; res.textContent = '‚è≥ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å...'; res.style.color = 'var(--mist)'; }

  try {
    const r = await fetch(OR_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + OR_KEY,
      },
      body: JSON.stringify({
        model: 'meta-llama/llama-3.3-70b-instruct:free',
        max_tokens: 20,
        messages: [{ role: 'user', content: '–°–∫–∞–∂–∏ "–û–ö" –ø–æ-—Ä—É—Å—Å–∫–∏' }]
      })
    });

    const data = await r.json();
    console.log('Test response:', JSON.stringify(data));

    if (!r.ok) {
      if (dot) dot.textContent = 'üî¥';
      if (res) { res.textContent = '‚ùå –û—à–∏–±–∫–∞ ' + r.status + ': ' + (data.error?.message || JSON.stringify(data)); res.style.color = 'var(--rose)'; }
      return;
    }

    const text = data.choices?.[0]?.message?.content;
    if (text) {
      if (dot) dot.textContent = 'üü¢';
      if (res) { res.textContent = '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç! –û—Ç–≤–µ—Ç: ' + text.trim(); res.style.color = 'var(--teal)'; }
    } else {
      if (dot) dot.textContent = 'üü°';
      if (res) { res.textContent = '‚ö†Ô∏è –°—Ç—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + JSON.stringify(data); res.style.color = 'var(--sr)'; }
    }
  } catch(e) {
    if (dot) dot.textContent = 'üî¥';
    if (res) { res.textContent = '‚ùå –°–µ—Ç—å: ' + e.message; res.style.color = 'var(--rose)'; }
  }
}

// ‚ïê‚ïê‚ïê RESET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function resetAll() {
  JOURNAL = []; TAROT = []; TODAY = {};
  CYCLE = { last:'', len:28, dur:5, history:[] };
  PROFILE = { name:'', dob:'' };
  await Promise.all([
    save(K.journal, JOURNAL), 
    save(K.tarot, TAROT), 
    save(K.today, TODAY),
    save(K.cycle, CYCLE),
    save(K.profile, PROFILE),
    // API_KEY is hardcoded ‚Äî nothing to reset
  ]);
  renderJournal(); renderTarotHistory(); renderCycle(); renderToday();
  toast('üîÑ –î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setText(id, val) { 
  const e = document.getElementById(id); 
  if(e) e.textContent = val; 
}

let toastTmr = null;
function toast(msg) {
  const el = document.getElementById('toast');
  if (!el) return;
  el.textContent = msg; el.classList.add('on');
  if (toastTmr) clearTimeout(toastTmr);
  toastTmr = setTimeout(() => el.classList.remove('on'), 3000);
}
</script>
</body>
</html>